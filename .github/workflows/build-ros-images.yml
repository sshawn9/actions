name: build-ros-images

on:
  workflow_dispatch:
    inputs:
      build_noetic: { type: boolean, default: true }
      build_humble: { type: boolean, default: true }
      build_jazzy:  { type: boolean, default: true }
      arch_amd64:   { type: boolean, default: true }
      arch_arm64:   { type: boolean, default: true }
      max_parallel_jobs: { type: number, default: 2 }
      rebuild_base:
        description: 'Rebuild Base Image(1 for enable)'
        required: true
        default: '1'
        type: choice
        options: ['1','0']
      rebuild_desktop:
        description: 'Rebuild Desktop Image(1 for enable)'
        required: true
        default: '1'
        type: choice
        options: ['1','0']
      rebuild_box:
        description: 'Rebuild Box Image(1 for enable)'
        required: true
        default: '1'
        type: choice
        options: ['1','0']
      manifest_tag:
        description: 'Customize Manifest Tag'
        required: false
        default: ''
        type: string

jobs:
  gen-matrix:
    runs-on: ubuntu-24.04
    outputs:
      build_matrix: ${{ steps.out.outputs.build_matrix }}
      build_count: ${{ steps.out.outputs.build_count }}
      manifest_matrix: ${{ steps.out.outputs.manifest_matrix }}
      manifest_count: ${{ steps.out.outputs.manifest_count }}
    steps:
      - id: out
        shell: bash
        run: |
          set -euo pipefail

          distros=()
          [[ "${{ inputs.build_noetic }}" == "true" ]] && distros+=(noetic)
          [[ "${{ inputs.build_humble }}" == "true" ]] && distros+=(humble)
          [[ "${{ inputs.build_jazzy  }}" == "true" ]] && distros+=(jazzy)

          arches=()
          [[ "${{ inputs.arch_amd64 }}" == "true" ]] && arches+=(amd64)
          [[ "${{ inputs.arch_arm64 }}" == "true" ]] && arches+=(arm64)

          build='[]'
          for d in "${distros[@]}"; do
            for a in "${arches[@]}"; do
              build="$(jq -c --arg d "$d" --arg a "$a" '. + [{"distro":$d,"arch":$a}]' <<<"$build")"
            done
          done
          echo "build_count=$(jq 'length' <<<"$build")" >> "$GITHUB_OUTPUT"
          echo "build_matrix={\"include\":$build}" >> "$GITHUB_OUTPUT"

          manifest='[]'
          if [[ "${{ inputs.arch_amd64 }}" == "true" && "${{ inputs.arch_arm64 }}" == "true" ]]; then
            for d in "${distros[@]}"; do
              manifest="$(jq -c --arg d "$d" '. + [{"distro":$d}]' <<<"$manifest")"
            done
          fi
          echo "manifest_count=$(jq 'length' <<<"$manifest")" >> "$GITHUB_OUTPUT"
          echo "manifest_matrix={\"include\":$manifest}" >> "$GITHUB_OUTPUT"

  build:
    needs: gen-matrix
    if: ${{ needs.gen-matrix.outputs.build_count != '0' }}
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(inputs.max_parallel_jobs) }}
      matrix: ${{ fromJson(needs.gen-matrix.outputs.build_matrix) }}
    uses: ./.github/workflows/build-ros-images-single.yml
    with:
      distro: ${{ matrix.distro }}
      arch: ${{ matrix.arch }}
      rebuild_base: ${{ inputs.rebuild_base }}
      rebuild_desktop: ${{ inputs.rebuild_desktop }}
      rebuild_box: ${{ inputs.rebuild_box }}
      manifest_tag: ${{ inputs.manifest_tag }}
    secrets: inherit

  manifest:
    needs: [gen-matrix, build]
    if: ${{ needs.gen-matrix.outputs.manifest_count != '0' }}
    strategy:
      fail-fast: false
      max-parallel: ${{ inputs.max_parallel_jobs }}
      matrix: ${{ fromJson(needs.gen-matrix.outputs.manifest_matrix) }}
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6

      - name: Publish multi-arch manifests
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: run
          version: latest
          workdir: build-ros-images
          args: uv run --locked python main.py
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
        env:
          TARGET_PLATFORMS: 'linux/amd64,linux/arm64'
          TARGET_DISTROS: ${{ matrix.distro }}

          MANIFEST_ONLY: '1'
          MANIFEST_TAG: ${{ inputs.manifest_tag }}

          REBUILD_BASE: ${{ inputs.rebuild_base }}
          REBUILD_DESKTOP: ${{ inputs.rebuild_desktop }}
          REBUILD_BOX: ${{ inputs.rebuild_box }}

          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
