name: build-ros-images

on:
  workflow_dispatch:
    inputs:
      build_noetic: { type: boolean, default: true }
      build_humble: { type: boolean, default: true }
      build_jazzy:  { type: boolean, default: true }
      arch_amd64:   { type: boolean, default: true }
      arch_arm64:   { type: boolean, default: true }
      max_parallel_jobs: { type: number,  default: 2 }
      rebuild_base:
        description: 'Rebuild Base Image(1 for enable)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '0'
      rebuild_desktop:
        description: 'Rebuild Desktop Image(1 for enable)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '0'
      rebuild_box:
        description: 'Rebuild Box Image(1 for enable)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '0'
      manifest_tag:
        description: 'Customize Manifest Tag'
        required: false
        default: ''
        type: string

jobs:
  build:
    name: build ${{ matrix.distro }} ${{ matrix.arch }}
    if: >-
      ${{
        (
          (matrix.distro == 'noetic' && inputs.build_noetic) ||
          (matrix.distro == 'humble' && inputs.build_humble) ||
          (matrix.distro == 'jazzy'  && inputs.build_jazzy)
        ) &&
        (
          (matrix.arch == 'amd64' && inputs.arch_amd64) ||
          (matrix.arch == 'arm64' && inputs.arch_arm64)
        )
      }}
    strategy:
      fail-fast: false
      max-parallel: ${{ inputs.max_parallel_jobs }}
      matrix:
        include:
          - { distro: noetic, arch: amd64, platform: linux/amd64, runner: ubuntu-24.04 }
          - { distro: noetic, arch: arm64, platform: linux/arm64, runner: ubuntu-24.04-arm }
          - { distro: humble, arch: amd64, platform: linux/amd64, runner: ubuntu-24.04 }
          - { distro: humble, arch: arm64, platform: linux/arm64, runner: ubuntu-24.04-arm }
          - { distro: jazzy,  arch: amd64, platform: linux/amd64, runner: ubuntu-24.04 }
          - { distro: jazzy,  arch: arm64, platform: linux/arm64, runner: ubuntu-24.04-arm }
    uses: ./.github/workflows/build-ros-images-single.yml
    with:
      distro: ${{ matrix.distro }}
      arch: ${{ matrix.arch }}
      rebuild_base: ${{ inputs.rebuild_base }}
      rebuild_desktop: ${{ inputs.rebuild_desktop }}
      rebuild_box: ${{ inputs.rebuild_box }}
      manifest_tag: ${{ inputs.manifest_tag }}
    secrets: inherit

  manifest:
    name: manifest ${{ matrix.distro }}
    needs: [ build ]
    if: >-
      ${{
        (
          (matrix.distro == 'noetic' && inputs.build_noetic) ||
          (matrix.distro == 'humble' && inputs.build_humble) ||
          (matrix.distro == 'jazzy'  && inputs.build_jazzy)
        ) && 
        (inputs.arch_amd64 && inputs.arch_arm64)
      }}
    strategy:
      fail-fast: false
      max-parallel: ${{ inputs.max_parallel_jobs }}
      matrix:
        include:
          - { distro: noetic, arch: amd64, platform: linux/amd64, runner: ubuntu-24.04 }
          - { distro: humble, arch: amd64, platform: linux/amd64, runner: ubuntu-24.04 }
          - { distro: jazzy,  arch: amd64, platform: linux/amd64, runner: ubuntu-24.04 }
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6

      - name: Publish multi-arch manifests
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: run
          version: latest
          workdir: build-ros-images
          args: uv run --locked python main.py
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
        env:
          TARGET_PLATFORMS: 'linux/amd64,linux/arm64'
          TARGET_DISTROS: ${{ matrix.distro }}

          MANIFEST_ONLY: '1'
          MANIFEST_TAG: ${{ inputs.manifest_tag }}

          REBUILD_BASE: ${{ inputs.rebuild_base }}
          REBUILD_DESKTOP: ${{ inputs.rebuild_desktop }}
          REBUILD_BOX: ${{ inputs.rebuild_box }}

          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
